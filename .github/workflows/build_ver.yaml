name: Build and Release - winLoadXRAY

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "pyinstaller>=6.3,<7"

      - name: Print Python info
        run: python -c "import sys; print('Python:', sys.version)"

      - name: pip check
        run: pip check

      - name: Export dependency snapshot
        run: pip freeze > pip-freeze.txt

      - name: Get version from winLoadXRAY.py
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content winLoadXRAY.py -Raw
          $version = ($content | Select-String 'APP_VERS\s*=\s*"([^"]+)"').Matches.Groups[1].Value
          if ([string]::IsNullOrEmpty($version)) {
            $version = "0.1.0"
          }
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version found: $version"

      - name: Build .exe with PyInstaller
        run: |
          pyinstaller --onefile --windowed --clean `
            --name winLoadXRAY `
            --hidden-import=PIL `
            --hidden-import=requests `
            --add-data "img;img" `
            --add-data "func;func" `
            winLoadXRAY.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts
          path: |
            dist/winLoadXRAY.exe
            pip-freeze.txt

      - name: Create GitHub Release
        id: create_release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $release_tag = "v$version"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Проверка существования тега локально
          $local_tags = git tag -l "$release_tag"
          if ($local_tags) {
            Write-Host "Tag $release_tag already exists locally"
          } else {
            Write-Host "Creating new tag: $release_tag"
            git tag "$release_tag"
          }

          # Пуш тега и создание релиза
          git push origin "$release_tag" 2>&1 || Write-Host "Tag may already exist"

          gh release create "$release_tag" dist/winLoadXRAY.exe `
            --title "winLoadXRAY $release_tag" `
            --notes "Release $release_tag of winLoadXRAY"`
